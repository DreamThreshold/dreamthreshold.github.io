<!DOCTYPE html>
    <html>
<!-- Created 2024-10-23 / Release 0.1 2024-11-21 -->
<head>
  <meta charset="UTF-8">
  <title>Comp/Decomp Country</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="icon" href="data:image/svg+xml;base64,PHN2ZwogICB3aWR0aD0iNjkuMzg5NTcybW0iCiAgIGhlaWdodD0iODcuNDI1MTg2bW0iCiAgIHZpZXdCb3g9IjAgMCA2OS4zODk1NzIgODcuNDI1MTg2IgogICB2ZXJzaW9uPSIxLjEiCiAgIGlkPSJzdmcxIgogICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxkZWZzCiAgICAgaWQ9ImRlZnMxIiAvPgogIDxnCiAgICAgaWQ9ImxheWVyMSIKICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTIuMjU5NDUxLC0zLjcwMjU1MzUpIj4KICAgIDxwYXRoCiAgICAgICBpZD0icGF0aDEiCiAgICAgICBzdHlsZT0iZmlsbDojYjNiMzAwO2ZpbGwtb3BhY2l0eToxO3N0cm9rZTpub25lO3N0cm9rZS13aWR0aDowLjM2Njk7c3Ryb2tlLW9wYWNpdHk6MC42OSIKICAgICAgIGQ9Im0gNTkuNDA2NDQzLDMuNzAyNTUzNSAtMi4yNjczMDUsMC42NTI0MTQgLTIuNDI0OTE1LDEuOTIyMzY1IDMuOTI4Nyw3LjY1OTczNzUgYyAwLDAgLTAuMDI1NTcsMjQuMTMzMTExIC02LjY0NDI5NywzNC4wNDA1NjEgLTEwLjAyOTEsMTYuNjM0NDk3IC0zNS43MjU1MywyNi4yOTgwNjIgLTM3Ljk0OTg4LDM3LjUzMzg4MiBsIC0xLjc4OTI5NSwyLjYwMDYxOCAwLjkyMjQyMiwyLjM3NTgyNSAyLjc0NDAyLC0wLjIwNTQyNSBjIDAsMCAxMy4zNjQyMSw0LjcyNzU5NyAzMy4zOTMzMSwtOC4xNzkwODggQyA3MC44NzE1MjgsNjguMjE1MTk4IDgyLjg0OTc3MSw1NS42MTEyNzEgODEuNTUzNjcxLDM0LjI4MzM2NiA4MC40NjQyMjgsMTYuMzU1OTkgNjYuNDgyMjM4LDExLjgyMzQ5NSA2Ni40ODIyMzgsMTEuODIzNDk1IFoiIC8+CiAgPC9nPgo8L3N2Zz4K" />

<style></style>

<link href="main.css" rel="stylesheet" />

</head>

<!-- for various string, array/matrix, data interleaving, and formatting functions -->
<script src="utilities.js"></script>

<!-- for various string, array/matrix, data interleaving, and formatting functions -->
<script src="compression.js"></script>

<!-- Our "3D" SVG script, for bitplanes and more -->
<script src="svg3d.js"></script>

<body>

  <svg width="100vw" height="100vh" style="position:absolute;">
    <!-- oooh banana -->
    <pattern id="bananas" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">

      <path d="M 31.320569 9.8309245
      L 30.413647 10.09189
      L 29.443681 10.860836
      L 31.015161 13.924731
      C 31.015161 13.924731 31.004927 23.577975 28.357442 27.540955
      C 24.345802 34.194754 14.06723 38.06018 13.17749 42.554508
      L 12.461772 43.594755
      L 12.830741 44.545085
      L 13.928349 44.462919
      C 13.928349 44.462919 19.274033 46.353958 27.285673 41.191284
      C 35.906603 35.635986 40.6979 30.594415 40.17946 22.063253
      C 39.743683 14.892303 34.150887 13.079305 34.150887 13.079305
      L 31.320569 9.8309245
      z

      M 81.320618 59.830973
      L 80.413696 60.091939
      L 79.44373 60.860885
      L 81.01521 63.92478
      C 81.01521 63.92478 81.004976 73.578023 78.357491 77.541003
      C 74.345851 84.194802 64.067279 88.060229 63.177539 92.554557
      L 62.46182 93.594804
      L 62.83079 94.545133
      L 63.928398 94.462968
      C 63.928398 94.462968 69.274082 96.354007 77.285722 91.191333
      C 85.906652 85.636035 90.697948 80.594464 90.179508 72.063302
      C 89.743731 64.892352 84.150936 63.079354 84.150936 63.079354
      L 81.320618 59.830973
      z" stroke="none" fill="rgb(30, 30, 30)" ></path>
    </pattern>

    <rect x="0" y="0" width="100vw" height="100vh" fill="url(#bananas)"></rect>

  </svg>


  <div class="main" id="main">
    <!-- <div id="animationBottom" class="animationBottom"></div> -->
    <div id="navbar"><h4><i style="padding-left:5ch;">Comp / Decomp Country</i></h4></div>
    <div id="panelgrid"></div>

  </div>


  <div id="animationTop" class="animationTop"></div>

<!-- for animations (mainly decompression animations) -->
<script src="animation.js"></script>

<!-- for GUI panels and their methods -->
<script src="panels.js"></script>

<!-- this is the main, inline script. 
 Afer the first major refactoring,
 The remaining stuff in here is mainly file stuff, HTML/buttons/canvas interaction, and UI class, plus the creation of the page elements.
 -->
<script>




class UImodel {
  constructor(grid, panelsParams, name=null ) {

    this.grid = grid;
    this.panels = [];

    for (let i = 0; i<panelsParams.length; i++){
        //HACK: surely a better way to do this but whatever
        if ( panelsParams[i][0] == "textDescription") {
          this.panels.push( new TextPanel(this,
            panelsParams[i][0], panelsParams[i][1], panelsParams[i][2],
            panelsParams[i][3], panelsParams[i][4], panelsParams[i][5],
            panelsParams[i][6], panelsParams[i][7] )
          );
          continue;
        }
        if ( panelsParams[i][0] == "fileIn") {
          this.panels.push( new FilePanel(this,
            panelsParams[i][0], panelsParams[i][1], panelsParams[i][2],
            panelsParams[i][3], panelsParams[i][4], panelsParams[i][5],
            panelsParams[i][6], panelsParams[i][7] )
          );
          continue;
        }
        this.panels.push( new Panel(this,
            panelsParams[i][0], panelsParams[i][1], panelsParams[i][2],
            panelsParams[i][3], panelsParams[i][4], panelsParams[i][5],
            panelsParams[i][6], panelsParams[i][7] )
        );

    }

    this.name = name;
    this.sources = []; // will contain source data from files
    this.links = [];

    // perform the linking of panels
    // for (let panel of this.panels){
    //     for (let link of panel.links){
    //         console.log(`Pushing link: [${link.name}] --> [${panel.name}]`);
    //         link.nexts.push(panel);
    //     }
    // }
    for (let panel of this.panels)
        for (let link of panel.links)
            link.nexts.push(panel);
    
  }
  addLink(){

  }
}

//
//   Create the ui and panels
//

aboutText = `\
              <div class="text_content" >
                <p>
                  <b>Hello!</b> This app compresses and decompresses graphics data from DKC, and provides visualizations that can help in ROM hacking.
                  <br><br>
                  It provides several panels with different applications:
                  <ul>
                    <li> <b>Hex Viewer</b>. View hexadecimal data from game files. If viewing a processed set of data, such as decompressed or compressed data, you can download it from the "☰" menu.<br>
                      <ul>
                        <li> After uploading valid compressed data, if there is a hex viewer panel for <i>de</i>compressed data, you can navigate to its "☰" menu and click "Animate Decompression Process". This will show you a visualization of the process, with data bytes given different shades to correspond to the decompression mode used. These graphics files contain many spans/blocks of compressed data, and each span has one of several possible compression/encoding modes, and usually an operand as well.</li>
                      </ul>
                    </li>
                    <li> <b>Bitplane Viewer</b>. Visualize SNES 4 bit per pixel graphics tiles and their weird intertwined format.<br>More details...
                      <ul>
                        <li> Upload a file to "Input - Compressed Data" to get started. This expects a .bin file that you might get in a disassembly of the game, usually in the "graphics/compressed" folder. Or, copy the hex values from the relevant offset of your ROM to a new file.</li>
                        <li> After uploading valid data, the bitplane diagram should appear, showing the first tile. In the diagram, you can see how the 32 bytes of data comprise the four bitplanes. Each pixel or "cell" of the 8x8 bitplane is stacked with those of the other bitplanes to form a color index of between 0 and 15 (0x0 to 0xF) for each pixel of the tile. For example, if the bitplanes read "1 0 1 0" from front to back for a given pixel, that pixel's index value will be "A".</li>
                        <li> The bitplane diagram is a 3d model and can rotate when dragged. ctrl+scroll to zoom in or out.</li>
                        <li> Click the "<" and ">" buttons near the top to flip through the tiles. Alternatively, if a tileset viewer panel is present, click a tile within that panel to show it in the bitplane viewer.</li>
                      </ul>
                    </li>
                    <li> <b>Palette Viewer</b>. View color palettes used in the game's levels. Select a row of colors (16-color sub-palette) to assign it to the indexed tile in the bitplane viewer. <br>(Currently uses the following forumla: <br>SNES 5 bit color channel  ×  8  =  RGB 8 bit channel<br> ... there are multiple ways to convert the colors.)</li>
                    <li> <b>Tileset Viewer</b>. View the 8x8 pixel tiles in their grayscale form, before they are assigned a color palette.</li>
                    <li> <b>Metatiles Viewer</b>. View 32x32 pixel metatiles. Each metatile is composed of 4x4 tiles, 16 total. Each of the metatiles is built using an associated color sub-palette, and potentially horizontal and/or vertical flip; hover to view these details. Requires graphics tiles, palette, and then tilemap32 to be uploaded. Make sure your tilemap32 matches your 8x8 tiles: for example, don't use a foreground/background tilemap on layer 3 tiles, or vice versa. Mainly meant for FG/BG.</li>
                    <li> <b>Level Map Viewer</b>. View level maps built from the metatiles. Currently only supports horizontal levels. Requires graphics tiles, palette, tilemap32, and then level map to be uploaded.</li>
                  </ul>
                  <br>
                  Most features require uploading a file to the relevant file input panels on the page. Data will persist through page refreshes, but not page closes.
                </p>
                <br>
                  Panels can be:<br>
                  <ul>
                      <li> moved around the page by dragging their headers</li>
                      <li> resized by dragging the bottom right corner</li>
                      <li> collapsed by clicking "˄" in the header</li>
                      <li> and maximized by double clicking the header.</li>
                    </ul>
                  Some panels also have settings or other features hidden in the "☰" menu. You can zoom out of the page (usually ctrl+scroll) to have more space to organize your panels. Depending on the initial panels template, some panels may be hidden off-screen at first.
  
                <br><br>
                <p>
                  The app's first release was made to celebrate DKC's 30th anniversary. The goal is to de-mystify DKC hacking and to provide even more appreciation for what Rare developed in the 1990s. More features will continue to be added. Works best in a full screen window, tested most thoroughly with firefox. You can expect more features for visualizing, documenting, and hacking the DKC series soon. Thanks!
                </p>
                <br><br>
                <p>
                  Special thanks to the DKC Atlas community members and their previous work. In particular Kingizor's dkcomp program. In the future I will update this page with additional guides and resources, and their proper credits.
                </p>
                <br><br><br>
                <p>
                <b>Disclaimer</b>. This software is not official or supported by Nintendo, nor any other commercial entity. It is provided AS IS, and its use is at your own risk.
                </p>
              </div>`;


// const ui = new UImodel( "main", document.getElementById("panelgrid") );
// var inputPanel = ui.addNode( new FilePanel ("Input - Compressed Data"),          [1,  3,    c0, d0]  );
// var compHexPanel = ui.addNode( new HexPanel ("Hex Viewer - Compressed Data"),          [1, 15,    c1, d1]  );
// ui.addLink( new Link(inputPanel, compHexPanel) )


// let c0 = 2, c1 = 11, c2 = 20, c3=29;
let c0 = 1, c1 = 6, c2 = 16, c3=27-3;
let cx = c2*1;
let dx = cx+5;
let d0 = c1, d1 = c2, d2=c3, d3=33;
// main decompression "pipeline"
//              _, kind,                  rows        cols     name=null, link, content=''
var inputPanel = ["fileIn",                1,  3,    c0, d0,  "Input - Compressed Data"];
var compHexPanel = ["hexViewerComp",       1, 10,    c1, d1,  "Hex Viewer - Compressed Data", [0]]; // 1
var paletteInputPanel = ["fileIn",         1,  3,    c3, d3,  "Input - Palette"];  //  2
var paletteViewer = ["paletteViewer",      3,  6,    c3, d3,  "Palette", [2]]; // 3
var decompHexPanel = ["hexViewer",        10, 19,    c1, d1,  "Hex Viewer - Decompressed Data", [0, 3, 1]]; // 4
var bitplanePanel = ["bitplaneViewer",     1, 15,    c2, d2,  "Bitplane Viewer - Decompressed Data", [4, 3]]; // 5
var tilesetViewer = ["tilesetViewer",     15, 19,    c2, d2-1,  "Tiles", [4, 3, 5]]; //  6   4, 3, 5
var metatilemapInputPanel = ["fileIn",     6,  8,    c3, d3,  "Input - Tilemap32 (Metatiles)"]; //  7
var metatilesViewer = ["metatilesViewer",  8, 15,    c3, d3,  "Tilemap32 (Metatiles)", [3,6,7]]; // 8 pal viewer, tileset vwr, metatile input
var levelMapInputPanel = ["fileIn",       15, 17,    c3, d3,  "Input - Level Map"]; //  9
var levelMapViewer = ["levelMapViewer",   17, 29,    c3, d3,  "Level Map", [3,8,9]]; // 10 paletteViewer, metatilesViewer, fileIn
var description = ["textDescription",      3, 19,    c0, d0,  "About Comp/Decomp Country", null, aboutText]; // 11

// for the Compression "pipeline"
var compPipelineText = `\
<div class="text_content" >
  <p>This group of panels (12-16) represents a separate pipeline from the others above.</p>
  <p>Enter <u>un</u>compressed data to the file input above to compress it. In the compressed data hex viewer to the right, you can download the compressed data file from the "☰" menu.</p><br>
  <p> Also to the right, below that, you'll see your newly-compressed data get re-decompressed, if you wanted to immediately verify it. You can also verify it with the associated tileset viewer to the right.
  </div>`;
var inputPanelC = ["fileIn",               20, 23,    c0, d0,  "Input - Uncompressed Data"];// 12
var compressC = ["hexViewerCompressed",    20, 24,    c1, d1,  "Hex Viewer - Compressed-by-this-app Data", [12]]; // 13
var decompressC = ["hexViewer",            24, 28,    c1, d1,  "Hex Viewer - Decompressed from compressed-by-this-app Data", [13]]; // 14
var tilesetViewerC = ["tilesetViewer",     24, 28,    c2, d2-1,  "Tiles", [14, null, null ]];
var descriptionC = ["textDescription",     23, 28,    c0, d0,  "About Compression", null, compPipelineText]; // 11

const ui = new UImodel(
        document.getElementById("panelgrid"),
        [ inputPanel, compHexPanel,
        paletteInputPanel, paletteViewer,
        decompHexPanel, bitplanePanel,
        tilesetViewer,
        metatilemapInputPanel, metatilesViewer,
        levelMapInputPanel, levelMapViewer,
        description,
              inputPanelC, compressC, decompressC, tilesetViewerC, descriptionC, 
      ],
        "main"
    );

let pg = document.getElementById("panelgrid");



</script>

</body>

</html>